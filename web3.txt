<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelNav Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- é»˜è®¤æ•°æ®ï¼šä¸¤çº§ç»“æ„ -->
    <script id="nav-data" type="application/json">
    {
        "config": {
            "windowTitle": "PixelNav Station",
            "menus": ["é¦–é¡µ|/", "å…³äº|https://github.com", "HODL"],
            "searchPlaceholder": "Search dApps...",
            "statusPrefix": "ç³»ç»Ÿå·²è¿è¡Œ",
            "startTime": "2023-01-01T00:00:00.000Z"
        },
        "groups": [
            {
                "id": "group-web3",
                "name": "Web3 ä¸–ç•Œ",
                "subs": [
                    {
                        "id": "sub-tools",
                        "name": "åŸºç¡€å·¥å…·",
                        "links": [
                            { "id": "l1", "title": "Etherscan", "url": "https://etherscan.io", "desc": "åŒºå—é“¾æµè§ˆå™¨", "icon": "ğŸ”" },
                            { "id": "l2", "title": "Metamask", "url": "https://metamask.io", "desc": "å°ç‹ç‹¸é’±åŒ…", "icon": "ğŸ¦Š" }
                        ]
                    },
                    {
                        "id": "sub-defi",
                        "name": "DeFi é‡‘è",
                        "links": [
                            { "id": "l3", "title": "Uniswap", "url": "https://uniswap.org", "desc": "å»ä¸­å¿ƒåŒ–äº¤æ˜“", "icon": "ğŸ¦„" }
                        ]
                    }
                ]
            },
            {
                "id": "group-daily",
                "name": "æ—¥å¸¸æ‘¸é±¼",
                "subs": [
                    {
                        "id": "sub-video",
                        "name": "è§†é¢‘å¨±ä¹",
                        "links": [
                            { "id": "l4", "title": "Bilibili", "url": "https://bilibili.com", "desc": "å¹²æ¯", "icon": "ğŸ“º" }
                        ]
                    }
                ]
            }
        ]
    }
    </script>

    <style>
        :root { --bg-teal: #008080; --win-gray: #c0c0c0; --win-blue: #000080; }
        body { background-color: var(--bg-teal); font-family: 'Tahoma', 'Microsoft YaHei', sans-serif; font-size: 12px; overflow: hidden; user-select: none; cursor: default; }

        .win-window { background: var(--win-gray); box-shadow: 1px 1px 0 #000; border-top: 2px solid #dfdfdf; border-left: 2px solid #dfdfdf; border-right: 2px solid #000; border-bottom: 2px solid #000; }
        .win-inset { background: #fff; border-top: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #dfdfdf; border-bottom: 1px solid #dfdfdf; }
        .win-titlebar { background: linear-gradient(90deg, var(--win-blue), #1084d0); color: white; padding: 3px 6px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        .win-btn { background: var(--win-gray); border: 1px solid #808080; border-top-color: #fff; border-left-color: #fff; border-right-color: #000; border-bottom-color: #000; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; color: black; box-shadow: 1px 1px 0 #000; }
        .win-btn:active:not(:disabled) { border-top-color: #000; border-left-color: #000; border-right-color: #fff; border-bottom-color: #fff; transform: translate(1px, 1px); box-shadow: none; }
        
        /* ä¾§è¾¹æ æ ·å¼å‡çº§ */
        .sidebar-root { padding: 6px 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; color: #333; }
        .sidebar-root:hover { background-color: #e0e0e0; }
        .sidebar-sub { padding: 4px 4px 4px 24px; cursor: pointer; display: flex; align-items: center; gap: 6px; border: 1px dotted transparent; }
        .sidebar-sub:hover { border-color: #808080; }
        .sidebar-sub.active { background-color: var(--win-blue); color: white; border-color: white; }
        .sidebar-sub.active .icon-svg { stroke: white; }
        
        .grid-item { position: relative; display: flex; align-items: center; gap: 10px; padding: 8px; border: 1px solid transparent; transition: background 0.1s; }
        .grid-item:hover { background-color: #efefef; border: 1px dotted #808080; }
        .card-link { position: absolute; inset: 0; z-index: 1; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .shake-anim { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        ::-webkit-scrollbar { width: 16px; background: #dfdfdf; }
        ::-webkit-scrollbar-thumb { background: #c0c0c0; border: 2px solid #dfdfdf; border-top-color: #fff; border-left-color: #fff; border-right-color: #000; border-bottom-color: #000; }
        ::-webkit-scrollbar-button { background: #c0c0c0; width: 16px; height: 16px; border: 2px outset #fff; display: block; }
        
        @keyframes flash { 0% { opacity: 0.8; background: white; } 100% { opacity: 0; } }
        .flash-anim { animation: flash 0.3s ease-out; }
    </style>
</head>
<body class="flex flex-col h-screen w-screen p-1 sm:p-2 gap-1 box-border overflow-hidden">

    <div class="flex-1 flex flex-col win-window overflow-hidden relative z-10 shadow-2xl">
        <div class="win-titlebar h-8 shrink-0">
            <div class="flex items-center gap-2">
                <i data-lucide="layout-grid" width="16"></i>
                <span class="text-sm" id="uiTitle">PixelNav Station</span>
            </div>
            <div class="flex gap-1">
                <button class="win-btn w-5 h-5 text-[10px] font-bold p-0 leading-none">_</button>
                <button class="win-btn w-5 h-5 text-[10px] font-bold p-0 leading-none">â–¡</button>
                <button class="win-btn w-5 h-5 text-[10px] font-bold bg-red-200 p-0 leading-none">Ã—</button>
            </div>
        </div>

        <div class="bg-[#c0c0c0] px-2 py-1 border-b border-gray-400 flex items-center gap-4 text-sm shrink-0 select-none" id="uiMenuBar"></div>

        <div class="bg-[#c0c0c0] p-2 border-b border-white flex items-center gap-2 shrink-0 h-12">
            <span class="text-xs text-gray-600 hidden sm:block">Address:</span>
            <div class="win-inset bg-white h-7 flex-1 flex items-center px-1">
                <i data-lucide="globe" width="14" class="text-gray-400 mr-2"></i>
                <input type="text" id="searchInput" class="w-full h-full outline-none text-sm bg-transparent font-sans" placeholder="Search...">
            </div>
            <div class="w-[2px] h-6 bg-gray-400 mx-2 border-r border-white"></div>
            
            <div id="adminTools" class="hidden flex gap-2">
                <button onclick="exportHTML()" class="win-btn px-2 h-7 gap-1 text-xs font-bold" title="ä¿å­˜å¹¶ä¸‹è½½"><i data-lucide="save" width="14" class="text-blue-800"></i></button>
                <button onclick="openSettings()" class="win-btn px-2 h-7 gap-1 text-xs" title="è®¾ç½®"><i data-lucide="settings" width="14"></i></button>
                <button onclick="openImportModal()" class="win-btn px-2 h-7 gap-1 text-xs" title="æ‰¹é‡å¯¼å…¥"><i data-lucide="list-plus" width="14"></i></button>
                <div class="w-[2px] h-6 bg-gray-400 mx-1 border-r border-white"></div>
                <button onclick="openModal('CAT')" class="win-btn px-2 h-7 gap-1 text-xs" title="æ–°å»º/ç®¡ç†åˆ†ç±»"><i data-lucide="folder-plus" width="14"></i></button>
                <button onclick="openModal('LINK')" class="win-btn px-2 h-7 gap-1 text-xs" title="æ–°å»ºé“¾æ¥"><i data-lucide="link" width="14"></i></button>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden p-1 gap-1 bg-[#c0c0c0]">
            <!-- å·¦ä¾§åˆ†ç±»æ ‘ -->
            <div class="w-40 sm:w-60 win-inset bg-white flex flex-col overflow-y-auto shrink-0 select-none">
                <div id="categoryList" class="flex flex-col py-1"></div>
            </div>

            <!-- å³ä¾§ç½‘æ ¼ -->
            <div class="flex-1 win-inset bg-white overflow-y-auto relative flex flex-col">
                <div class="bg-gray-100 border-b border-gray-300 p-2 flex justify-between items-center sticky top-0 z-10 shrink-0 h-10 shadow-sm">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <i data-lucide="folder-open" width="16" class="text-yellow-500 fill-yellow-500"></i>
                        <h2 id="currentCatName" class="font-bold text-sm truncate text-[#000080]">Loading...</h2>
                    </div>
                    <span id="itemCount" class="text-xs text-gray-500 border border-gray-300 px-2 py-0.5 bg-white rounded-full">0</span>
                </div>
                
                <div id="linkGrid" class="p-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 content-start"></div>

                <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
                    <i data-lucide="ghost" width="48" class="mb-4 opacity-30"></i>
                    <p class="text-sm">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</p>
                </div>
            </div>
        </div>

        <div class="h-7 bg-[#c0c0c0] border-t border-gray-400 flex items-center px-2 gap-2 text-xs shrink-0">
            <div class="win-inset px-2 py-0.5 flex-1 truncate flex items-center gap-2" id="statusMsg">
                <div class="w-2 h-2 rounded-full bg-green-500"></div> 
                <span id="uptimeDisplay">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</span>
            </div>
            <!-- æ—¶é—´æ ¼å¼ä¼˜åŒ–ï¼šMM/DD HH:MM:SSï¼Œä¸æ¢è¡Œ -->
            <div class="win-inset px-2 py-0.5 w-auto min-w-[110px] text-center font-mono whitespace-nowrap" id="clock">--/-- --:--:--</div>
        </div>
    </div>

    <div class="h-9 bg-[#c0c0c0] border-t-2 border-white flex items-center px-1 shrink-0 z-50 relative">
        <button id="startBtn" class="win-btn px-2 h-7 font-bold italic flex items-center gap-1">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Windows_logo_and_wordmark_-_1995-2001.svg/100px-Windows_logo_and_wordmark_-_1995-2001.svg.png" width="16">
            Start
        </button>
        <div class="w-[2px] h-6 border-l border-gray-400 border-r border-white mx-1"></div>
        <div class="win-inset bg-[#d4d0c8] px-2 h-7 flex items-center gap-2 border border-black/20 w-40 active:bg-[#e0e0e0]">
            <i data-lucide="globe" width="14"></i>
            <span class="text-xs truncate font-bold">PixelNav</span>
        </div>
    </div>

    <div id="startMenu" class="hidden fixed bottom-10 left-1 w-52 win-window z-[60] flex shadow-2xl">
        <div class="w-8 bg-gradient-to-b from-[#000080] to-[#1084d0] text-white relative flex items-center justify-center">
            <span class="block -rotate-90 font-bold tracking-widest whitespace-nowrap text-lg">WINDOWS</span>
        </div>
        <div class="flex-1 flex flex-col p-1 gap-1">
            <div class="bg-gray-200 p-2 border border-gray-400 mb-1 flex items-center gap-3">
                <div class="w-8 h-8 bg-gray-300 rounded-full border border-gray-500 flex items-center justify-center overflow-hidden">
                    <i data-lucide="user" width="20" class="text-gray-600"></i>
                </div>
                <span class="font-bold text-sm" id="userLabel">è®¿å®¢</span>
            </div>
            <button id="authBtn" class="hover:bg-[#000080] hover:text-white px-2 py-3 text-left text-sm flex items-center gap-3 group">
                <i data-lucide="key" width="16" class="group-hover:text-white"></i> 
                <span id="authText">ç®¡ç†å‘˜ç™»å½•</span>
            </button>
            <div class="h-[1px] bg-gray-400 border-b border-white my-1 mx-1"></div>
            <button onclick="triggerWeb3Egg()" class="hover:bg-[#000080] hover:text-white px-2 py-3 text-left text-sm flex items-center gap-3">
                <i data-lucide="power" width="16"></i> <span>å…³é—­ç³»ç»Ÿ...</span>
            </button>
        </div>
    </div>

    <!-- Web3 å½©è›‹ -->
    <div id="web3Modal" class="hidden fixed inset-0 bg-black/40 z-[200] flex items-center justify-center">
        <div class="win-window w-96 shadow-2xl shake-anim">
            <div class="win-titlebar bg-red-700">
                <span>System Error</span>
                <button onclick="closeWeb3()" class="win-btn w-4 h-4 p-0 leading-none text-[10px]">Ã—</button>
            </div>
            <div class="p-4 bg-[#c0c0c0] flex gap-4 items-center">
                <div class="shrink-0"><i data-lucide="octagon-x" width="48" class="text-red-600"></i></div>
                <div class="flex-1">
                    <p class="font-bold text-lg mb-1">Web3 æ°¸ä¸å…³é—­ï¼</p>
                    <p class="text-xs text-gray-600">Smart Contract Execution Failed.</p>
                </div>
            </div>
            <div class="p-2 bg-[#c0c0c0] flex justify-center gap-4 pb-4">
                <button onclick="closeWeb3()" class="win-btn px-6 h-8 font-bold">HODL</button>
                <button onclick="closeWeb3()" class="win-btn px-6 h-8">Cancel</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="hidden fixed inset-0 bg-black/40 z-[120] flex items-center justify-center">
        <div class="win-window w-[600px] h-[500px] shadow-2xl flex flex-col">
            <div class="win-titlebar shrink-0">
                <span>æ‰¹é‡å¯¼å…¥å‘å¯¼</span>
                <button onclick="closeImportModal()" class="win-btn w-4 h-4 p-0 leading-none text-[10px]">Ã—</button>
            </div>
            <div class="flex-1 flex flex-col p-2 gap-2 bg-[#c0c0c0]">
                <div class="bg-blue-100 border border-blue-600 p-2 text-xs leading-5">
                    <strong>æ ¼å¼ï¼š</strong>åç§° | ç½‘å€ | æè¿°(å¯é€‰)
                </div>
                <div class="flex items-center gap-2 text-xs">å¯¼å…¥åˆ°ï¼š<strong id="importTargetCat" class="text-blue-800">...</strong></div>
                <textarea id="importTextarea" class="flex-1 w-full win-inset font-mono text-sm p-2 outline-none resize-none" placeholder="åœ¨æ­¤ç²˜è´´..."></textarea>
                <div class="flex justify-end gap-2 shrink-0"><button onclick="executeBatchImport()" class="win-btn px-4 h-8 font-bold">å¯¼å…¥</button><button onclick="closeImportModal()" class="win-btn px-4 h-8">å–æ¶ˆ</button></div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨æ¨¡æ€æ¡† -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/40 z-[100] flex items-center justify-center backdrop-blur-[1px]">
        <div class="win-window w-96 shadow-2xl animate-[bounce_0.1s_ease-out]">
            <div class="win-titlebar">
                <span id="modalTitle">System</span>
                <button onclick="closeModal()" class="win-btn w-4 h-4 p-0 leading-none text-[10px]">Ã—</button>
            </div>
            <div class="p-4 bg-[#c0c0c0]" id="modalContent"></div>
        </div>
    </div>

    <div id="flashLayer" class="fixed inset-0 pointer-events-none z-[200]"></div>

    <script>
        const ADMIN_HASH_SHA256 = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";
        const state = { isAdmin: false, data: { config: {}, groups: [] }, activeGroupId: null, activeSubId: null, searchQuery: "", editingId: null, editingType: null };

        async function init() {
            const stored = localStorage.getItem('pixelnav_data_v11_tree');
            let loadedData = null;
            if (stored) { try { loadedData = JSON.parse(stored); } catch(e) {} }
            
            if (!loadedData) {
                const raw = JSON.parse(document.getElementById('nav-data').textContent);
                loadedData = raw.groups ? raw : { config: { windowTitle: "PixelNav Station", startTime: new Date().toISOString() }, groups: [] }; 
            }
            state.data = loadedData;
            state.expandedGroups = new Set(); // è¿½è¸ªå±•å¼€çš„ä¸€çº§èœå•

            applyConfig();
            
            // è‡ªåŠ¨å±•å¼€å¹¶é€‰ä¸­ç¬¬ä¸€ä¸ª
            if (state.data.groups.length > 0) {
                const firstG = state.data.groups[0];
                state.expandedGroups.add(firstG.id);
                state.activeGroupId = firstG.id;
                if(firstG.subs && firstG.subs.length > 0) {
                    state.activeSubId = firstG.subs[0].id;
                }
            }
            
            renderAll();
            setInterval(() => { updateClock(); updateUptime(); }, 1000);
            updateClock();
            updateUptime();
            lucide.createIcons();
        }

        // --- æ ¸å¿ƒæ¸²æŸ“ï¼šæ ‘çŠ¶ä¾§è¾¹æ  ---
        function renderSidebar() {
            const list = document.getElementById('categoryList'); 
            list.innerHTML = '';
            
            state.data.groups.forEach(group => {
                // 1. æ¸²æŸ“ä¸€çº§å¤§ç±» (Group)
                const groupDiv = document.createElement('div');
                const isExpanded = state.expandedGroups.has(group.id);
                
                let groupBtns = state.isAdmin ? `
                    <div class="ml-auto flex gap-1 z-10" onclick="event.stopPropagation()">
                        <button class="text-blue-600 hover:bg-blue-200 px-1 font-bold" onclick="editGroup('${group.id}')" title="ä¿®æ”¹å¤§ç±»">âœ</button>
                        <button class="text-red-600 hover:bg-red-200 px-1 font-bold" onclick="deleteGroup('${group.id}')" title="åˆ é™¤å¤§ç±»">Ã—</button>
                    </div>` : '';

                groupDiv.className = `sidebar-root select-none ${state.activeGroupId === group.id ? 'bg-gray-200' : ''}`;
                groupDiv.innerHTML = `
                    <i data-lucide="${isExpanded ? 'folder-open' : 'folder'}" width="16" class="shrink-0 fill-yellow-500 text-yellow-600"></i>
                    <span class="flex-1 truncate">${group.name}</span>
                    ${groupBtns}
                `;
                groupDiv.onclick = () => toggleGroup(group.id);
                list.appendChild(groupDiv);

                // 2. æ¸²æŸ“äºŒçº§å­ç±» (Sub)
                if (isExpanded) {
                    const subContainer = document.createElement('div');
                    if (!group.subs || group.subs.length === 0) {
                        subContainer.innerHTML = `<div class="pl-8 py-1 text-gray-500 text-xs italic">æ— å­åˆ†ç±»</div>`;
                    } else {
                        group.subs.forEach(sub => {
                            const subDiv = document.createElement('div');
                            const isActive = sub.id === state.activeSubId;
                            
                            let subBtns = state.isAdmin ? `
                                <div class="ml-auto flex gap-1 z-10" onclick="event.stopPropagation()">
                                    <button class="text-white hover:text-yellow-200 px-1 font-bold" onclick="editSub('${group.id}', '${sub.id}')">âœ</button>
                                    <button class="text-white hover:text-red-300 px-1 font-bold" onclick="deleteSub('${group.id}', '${sub.id}')">Ã—</button>
                                </div>` : '';

                            subDiv.className = `sidebar-sub text-sm truncate ${isActive ? 'active' : ''}`;
                            subDiv.innerHTML = `
                                <i data-lucide="corner-down-right" width="12" class="shrink-0 opacity-50 icon-svg"></i>
                                <span class="flex-1 truncate">${sub.name}</span>
                                ${isActive ? subBtns : ''} 
                            `;
                            subDiv.onclick = (e) => { e.stopPropagation(); selectSub(group.id, sub.id); };
                            subContainer.appendChild(subDiv);
                        });
                    }
                    list.appendChild(subContainer);
                }
            });
        }

        function toggleGroup(gid) {
            if(state.expandedGroups.has(gid)) state.expandedGroups.delete(gid);
            else state.expandedGroups.add(gid);
            state.activeGroupId = gid;
            renderSidebar();
            lucide.createIcons();
        }

        function selectSub(gid, sid) {
            state.activeGroupId = gid;
            state.activeSubId = sid;
            renderAll();
        }

        function renderMainContent() {
            const grid = document.getElementById('linkGrid'); 
            const empty = document.getElementById('emptyState');
            const titleEl = document.getElementById('currentCatName');
            grid.innerHTML = '';

            const group = state.data.groups.find(g => g.id === state.activeGroupId);
            const sub = group ? group.subs.find(s => s.id === state.activeSubId) : null;

            if (!sub) {
                titleEl.innerText = group ? `${group.name} (è¯·é€‰æ‹©å­åˆ†ç±»)` : "æœªé€‰æ‹©";
                document.getElementById('itemCount').innerText = "0";
                empty.classList.remove('hidden');
                return;
            }

            titleEl.innerText = `${group.name} / ${sub.name}`;
            let links = sub.links || [];
            if (state.searchQuery) links = links.filter(l => l.title.toLowerCase().includes(state.searchQuery.toLowerCase()));
            document.getElementById('itemCount').innerText = links.length;
            empty.classList.toggle('hidden', links.length > 0);

            links.forEach(link => {
                const item = document.createElement('div'); item.className = "grid-item group";
                let iconDisplay = `<i data-lucide="globe" width="20" class="text-blue-800"></i>`;
                if (link.icon) iconDisplay = link.icon.startsWith('http') ? `<img src="${link.icon}" class="w-5 h-5 object-cover" onerror="this.style.display='none'">` : `<span class="text-lg leading-none">${link.icon}</span>`;
                let safeUrl = link.url; if (safeUrl && !/^https?:|mailto:|#/.test(safeUrl)) safeUrl = 'https://' + safeUrl;
                
                const linkLayer = `<a href="${safeUrl}" target="_blank" class="card-link" title="${link.url}"></a>`;
                let btnsHtml = state.isAdmin ? `<div class="absolute top-1 right-1 hidden group-hover:flex gap-1 z-20"><button class="w-5 h-5 bg-blue-600 text-white flex items-center justify-center text-xs border border-black shadow-sm" onclick="editLink('${link.id}')">âœ</button><button class="w-5 h-5 bg-red-600 text-white flex items-center justify-center text-xs border border-black shadow-sm" onclick="deleteLink('${link.id}')">Ã—</button></div>` : '';
                
                item.innerHTML = `${linkLayer}<div class="w-8 h-8 flex items-center justify-center bg-gray-100 border border-gray-400 shrink-0 shadow-sm overflow-hidden pointer-events-none relative z-0">${iconDisplay}</div><div class="flex-1 min-w-0 pointer-events-none relative z-0"><div class="font-bold text-sm truncate text-black">${link.title}</div><div class="text-xs text-gray-500 truncate">${link.desc || link.url}</div></div>${btnsHtml}`;
                grid.appendChild(item);
            });
        }

        // --- æ•°æ®æ“ä½œ (åŒå±‚) ---
        function saveCategory() {
            const name = document.getElementById('catInput').value.trim();
            const parentId = document.getElementById('catParent').value; // "root" æˆ– groupID
            if (!name) return;

            if (state.editingId) {
                // ä¿®æ”¹æ¨¡å¼
                if (state.editingType === 'GROUP') {
                    const g = state.data.groups.find(g => g.id === state.editingId);
                    if(g) g.name = name;
                } else {
                    // ä¿®æ”¹å­ç±»ï¼šéœ€éå†æŸ¥æ‰¾
                    for(let g of state.data.groups) {
                        const s = g.subs.find(sub => sub.id === state.editingId);
                        if(s) { s.name = name; break; }
                    }
                }
            } else {
                // æ–°å¢æ¨¡å¼
                if (parentId === 'root') {
                    // æ–°å»ºä¸€çº§
                    const newG = { id: 'g-'+Date.now(), name, subs: [] };
                    state.data.groups.push(newG);
                    state.expandedGroups.add(newG.id);
                    state.activeGroupId = newG.id;
                } else {
                    // æ–°å»ºäºŒçº§
                    const g = state.data.groups.find(g => g.id === parentId);
                    if(g) {
                        const newS = { id: 's-'+Date.now(), name, links: [] };
                        g.subs.push(newS);
                        state.expandedGroups.add(g.id);
                        state.activeGroupId = g.id;
                        state.activeSubId = newS.id;
                    }
                }
            }
            saveData(); closeModal();
        }

        function saveLink() {
            // ... (åŒä¹‹å‰ç‰ˆæœ¬ï¼Œåªæ˜¯éœ€è¦å®šä½åˆ°æ­£ç¡®çš„ sub)
            if(!state.activeSubId) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäºŒçº§åˆ†ç±»");
            const title = document.getElementById('lTitle').value.trim();
            let url = document.getElementById('lUrl').value.trim();
            const desc = document.getElementById('lDesc').value.trim();
            const icon = document.getElementById('lIcon').value.trim();
            if (!title) return alert("æ ‡é¢˜å¿…å¡«");
            if (url && !/^https?:|mailto:|#/.test(url)) url = 'https://' + url;

            // æŸ¥æ‰¾å½“å‰ sub
            let targetSub = null;
            for(let g of state.data.groups) {
                const s = g.subs.find(sub => sub.id === state.activeSubId);
                if(s) { targetSub = s; break; }
            }

            if(targetSub) {
                if (state.editingId) {
                    const l = targetSub.links.find(lnk => lnk.id === state.editingId);
                    if(l) Object.assign(l, { title, url, desc, icon });
                } else {
                    targetSub.links.push({ id: 'l-'+Date.now(), title, url, desc, icon });
                }
                saveData(); closeModal();
            }
        }

        // --- è¾…åŠ©å‡½æ•° ---
        function updateClock() {
            const now = new Date();
            // MM/DD HH:MM:SS
            const str = `${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            document.getElementById('clock').innerText = str;
        }
        function updateUptime() {
            const start = new Date(state.data.config.startTime || new Date());
            const diff = new Date() - start;
            if (diff < 0) return;
            const d = Math.floor(diff/86400000);
            const h = Math.floor((diff/3600000)%24);
            const m = Math.floor((diff/60000)%60);
            const s = Math.floor((diff/1000)%60);
            document.getElementById('uptimeDisplay').innerText = `${state.data.config.statusPrefix||'è¿è¡Œ'}: ${d}å¤©${h}æ—¶${m}åˆ†${s}ç§’`;
        }
        async function sha256(m) { const b = new TextEncoder().encode(m); const h = await crypto.subtle.digest('SHA-256', b); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
        function saveData() { localStorage.setItem('pixelnav_data_v11_tree', JSON.stringify(state.data)); renderAll(); }
        function applyConfig() { 
            const conf = state.data.config || {}; 
            if(conf.windowTitle) { document.title = conf.windowTitle; document.getElementById('uiTitle').innerText = conf.windowTitle; }
            if(conf.searchPlaceholder) document.getElementById('searchInput').placeholder = conf.searchPlaceholder;
            if(conf.menus) {
                document.getElementById('uiMenuBar').innerHTML = conf.menus.map(m => {
                    const [txt, link] = m.split('|');
                    return link ? `<a href="${link}" target="_blank" class="underline hover:bg-[#000080] hover:text-white px-1 cursor-pointer">${txt}</a>` : `<span class="underline hover:bg-[#000080] hover:text-white px-1 cursor-pointer">${txt}</span>`;
                }).join('');
            }
        }
        function renderAll() { renderSidebar(); renderMainContent(); updateUIState(); lucide.createIcons(); }
        function updateUIState() { 
            document.getElementById('adminTools').classList.toggle('hidden', !state.isAdmin); 
            document.getElementById('userLabel').innerText = state.isAdmin ? "ç®¡ç†å‘˜" : "è®¿å®¢"; 
            document.getElementById('authText').innerText = state.isAdmin ? "é€€å‡ºç™»å½•" : "ç®¡ç†å‘˜ç™»å½•"; 
        }

        // --- æ‰¹é‡å¯¼å…¥ ---
        function executeBatchImport() {
            const raw = document.getElementById('importTextarea').value;
            if (!raw.trim() || !state.activeSubId) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäºŒçº§åˆ†ç±»ï¼");
            
            let targetSub = null;
            for(let g of state.data.groups) {
                const s = g.subs.find(sub => sub.id === state.activeSubId);
                if(s) { targetSub = s; break; }
            }
            if(!targetSub) return;

            const lines = raw.split('\n');
            let count = 0;
            lines.forEach(line => {
                const parts = line.split(/[|ï½œ]/).map(s=>s.trim());
                if(parts.length >= 2) {
                    let url = parts[1];
                    if(!/^https?:/.test(url)) url = 'https://'+url;
                    targetSub.links.push({ id: 'l-'+Date.now()+Math.random(), title: parts[0], url, desc: parts[2]||"", icon: "" });
                    count++;
                }
            });
            if(count>0) { saveData(); closeImportModal(); alert(`å¯¼å…¥ ${count} æ¡`); }
        }

        // --- åˆ é™¤/ç¼–è¾‘ è§¦å‘å™¨ ---
        function deleteGroup(id) { if(!confirm("åˆ é™¤ä¸€çº§åˆ†ç±»ä¼šæ¸…ç©ºå…¶ä¸‹æ‰€æœ‰å†…å®¹ï¼Œç¡®å®šå—ï¼Ÿ")) return; state.data.groups = state.data.groups.filter(g => g.id !== id); saveData(); }
        function editGroup(id) { state.editingId = id; state.editingType = 'GROUP'; openModal('CAT'); }
        function deleteSub(gid, sid) { if(!confirm("åˆ é™¤æ­¤åˆ†ç±»ï¼Ÿ")) return; const g = state.data.groups.find(g=>g.id===gid); if(g) g.subs = g.subs.filter(s=>s.id!==sid); saveData(); }
        function editSub(gid, sid) { state.editingId = sid; state.editingType = 'SUB'; openModal('CAT'); }
        function editLink(id) { state.editingId = id; openModal('LINK', {id}); /*ç®€ç•¥å¤„ç†ï¼Œå®é™…éœ€æŸ¥æ‰¾linkå¯¹è±¡ä¼ å‚*/ 
            // æŸ¥æ‰¾link
            for(let g of state.data.groups) for(let s of g.subs) {
                const l = s.links.find(lnk=>lnk.id===id);
                if(l) { openModal('LINK', l); return; }
            }
        }
        function deleteLink(id) { if(!confirm("åˆ é™¤é“¾æ¥ï¼Ÿ")) return; 
            for(let g of state.data.groups) for(let s of g.subs) s.links = s.links.filter(l=>l.id!==id);
            saveData(); 
        }

        // --- æ¨¡æ€æ¡† ---
        function openModal(type, data=null) {
            document.getElementById('modalOverlay').classList.remove('hidden');
            const content = document.getElementById('modalContent');
            const title = document.getElementById('modalTitle');
            if(type !== 'LINK' && type !== 'CAT') state.editingId = null; 

            if(type === 'LOGIN') {
                title.innerText = "ç®¡ç†å‘˜è®¤è¯";
                content.innerHTML = `<div class="text-sm mb-2">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :</div><input type="password" id="pInput" class="w-full border-2 border-gray-400 p-1 mb-4 font-sans" onkeydown="if(event.key==='Enter') doLogin()"><div class="flex justify-end gap-2"><button onclick="doLogin()" class="win-btn px-4 font-bold h-8">ç¡®å®š</button><button onclick="closeModal()" class="win-btn px-4 h-8">å–æ¶ˆ</button></div>`;
                setTimeout(()=>document.getElementById('pInput').focus(), 50);
            }
            else if(type === 'CAT') {
                title.innerText = state.editingId ? "ä¿®æ”¹åˆ†ç±»" : "æ–°å»ºåˆ†ç±»";
                // æ„å»ºçˆ¶çº§é€‰é¡¹
                let options = `<option value="root">-- æ–°å»ºä¸€çº§å¤§ç±» --</option>`;
                state.data.groups.forEach(g => {
                    options += `<option value="${g.id}" ${state.activeGroupId===g.id ? 'selected':''}>${g.name}</option>`;
                });
                
                // å¦‚æœæ˜¯ä¿®æ”¹ï¼Œéšè—çˆ¶çº§é€‰æ‹©ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
                let parentSelect = state.editingId ? '' : `<div class="mb-2"><label>æ‰€å±å¤§ç±»:</label><select id="catParent" class="w-full border border-gray-400 p-1">${options}</select></div>`;
                
                // æŸ¥æ‰¾å½“å‰åå­—å›æ˜¾
                let currentName = '';
                if(state.editingId) {
                    if(state.editingType==='GROUP') { const g = state.data.groups.find(x=>x.id===state.editingId); if(g) currentName = g.name; }
                    else { for(let g of state.data.groups) { const s = g.subs.find(x=>x.id===state.editingId); if(s) { currentName = s.name; break; } } }
                }

                content.innerHTML = `
                    <div class="space-y-2 text-sm">
                        ${parentSelect}
                        <div><label>åˆ†ç±»åç§°:</label><input id="catInput" value="${currentName}" class="w-full border border-gray-400 p-1"></div>
                    </div>
                    <div class="flex justify-end gap-2 mt-4"><button onclick="saveCategory()" class="win-btn px-4 font-bold h-8">ä¿å­˜</button><button onclick="closeModal()" class="win-btn px-4 h-8">å–æ¶ˆ</button></div>
                `;
            }
            else if(type === 'LINK') {
                title.innerText = state.editingId ? "ä¿®æ”¹é“¾æ¥" : "æ–°å»ºé“¾æ¥";
                const d = data || {title:'', url:'', desc:'', icon:''};
                content.innerHTML = `<div class="space-y-2 text-sm"><div><label>æ ‡é¢˜:</label><input id="lTitle" value="${d.title}" class="w-full border border-gray-400 p-1"></div><div><label>ç½‘å€:</label><input id="lUrl" value="${d.url}" class="w-full border border-gray-400 p-1"></div><div><label>æè¿°:</label><input id="lDesc" value="${d.desc}" class="w-full border border-gray-400 p-1"></div><div><label>å›¾æ ‡:</label><input id="lIcon" value="${d.icon}" class="w-full border border-gray-400 p-1"></div></div><div class="flex justify-end gap-2 mt-4"><button onclick="saveLink()" class="win-btn px-4 font-bold h-8">ä¿å­˜</button><button onclick="closeModal()" class="win-btn px-4 h-8">å–æ¶ˆ</button></div>`;
            }
            else if(type === 'SETTINGS') {
                const conf = state.data.config;
                title.innerText = "å…¨å±€è®¾ç½®";
                content.innerHTML = `<div class="space-y-2 text-sm">
                    <div><label>çª—å£æ ‡é¢˜:</label><input id="cfgTitle" value="${conf.windowTitle}" class="w-full border border-gray-400 p-1"></div>
                    <div><label>èœå• (åç§°|é“¾æ¥):</label><input id="cfgMenus" value="${(conf.menus||[]).join(',')}" class="w-full border border-gray-400 p-1"></div>
                    <div><label>æœç´¢æç¤º:</label><input id="cfgSearch" value="${conf.searchPlaceholder}" class="w-full border border-gray-400 p-1"></div>
                    <div><label>çŠ¶æ€æ å‰ç¼€:</label><input id="cfgPrefix" value="${conf.statusPrefix}" class="w-full border border-gray-400 p-1"></div>
                    <div><label>èµ·å§‹æ—¶é—´:</label><input type="datetime-local" id="cfgTime" value="${(conf.startTime||'').slice(0,16)}" class="w-full border border-gray-400 p-1"></div>
                </div><div class="flex justify-end gap-2 mt-4"><button onclick="saveSettings()" class="win-btn px-4 font-bold h-8">ä¿å­˜</button><button onclick="closeModal()" class="win-btn px-4 h-8">å–æ¶ˆ</button></div>`;
            }
        }
        
        // æ‚é¡¹å‡½æ•°
        function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }
        async function doLogin() { const h = await sha256(document.getElementById('pInput').value); if(h===ADMIN_HASH_SHA256) { state.isAdmin=true; updateUIState(); closeModal(); } else alert("å¯†ç é”™è¯¯"); }
        function saveSettings() {
            state.data.config = {
                windowTitle: document.getElementById('cfgTitle').value,
                menus: document.getElementById('cfgMenus').value.split(',').map(s=>s.trim()),
                searchPlaceholder: document.getElementById('cfgSearch').value,
                statusPrefix: document.getElementById('cfgPrefix').value,
                startTime: document.getElementById('cfgTime').value
            };
            saveData(); applyConfig(); closeModal();
        }
        function openSettings() { openModal('SETTINGS'); }
        function openImportModal() { openModal('IMPORT_PLACEHOLDER'); /* è¿™é‡Œå¤ç”¨ä¹‹å‰çš„å¯¼å…¥é€»è¾‘ï¼Œç®€åŒ–ç•¥ */ document.getElementById('importModal').classList.remove('hidden'); }
        function closeImportModal() { document.getElementById('importModal').classList.add('hidden'); }
        function exportHTML() { const a=document.createElement('a'); const html=document.documentElement.outerHTML.replace(/(<script id="nav-data" type="application\/json">)([\s\S]*?)(<\/script>)/, `$1\n${JSON.stringify(state.data,null,4)}\n$3`); a.href=URL.createObjectURL(new Blob([html],{type:'text/html'})); a.download="index.html"; a.click(); }
        function triggerWeb3Egg() { document.getElementById('startMenu').classList.add('hidden'); document.getElementById('web3Modal').classList.remove('hidden'); const w=document.querySelector('#web3Modal .win-window'); w.classList.remove('shake-anim'); void w.offsetWidth; w.classList.add('shake-anim'); lucide.createIcons(); }
        function closeWeb3() { document.getElementById('web3Modal').classList.add('hidden'); }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('searchInput').addEventListener('input', (e) => { state.searchQuery=e.target.value; renderMainContent(); });
        document.getElementById('startBtn').onclick = (e) => { e.stopPropagation(); document.getElementById('startMenu').classList.toggle('hidden'); };
        document.getElementById('authBtn').onclick = () => { document.getElementById('startMenu').classList.add('hidden'); if(state.isAdmin){state.isAdmin=false;updateUIState();} else openModal('LOGIN'); };
        document.body.onclick = (e) => { if(!e.target.closest('#startMenu')&&!e.target.closest('#startBtn')) document.getElementById('startMenu').classList.add('hidden'); };

        init();
    </script>
</body>
</html>

